// MARK: - Generated file, do NOT edit
// any edits of this file WILL be overwritten and thus discarded
// see section `gyb` in `README` for details.

import Foundation
@testable import K1
import Testing

private func doTest<PubKey: _K1PublicKeyProtocol & Equatable, Encoding: Equatable>(
	original makeOriginal: @autoclosure () -> PubKey,
	serialize: KeyPath<PubKey, Encoding>,
	deserialize: (Encoding) throws -> PubKey
) throws {
	try doTestSerializationRoundtrip(
		original: makeOriginal(),
		serialize: serialize,
		deserialize: deserialize
	)
}

public func doTestSerializationRoundtrip<T, Enc>(
	original makeOriginal: @autoclosure () -> T,
	serialize: KeyPath<T, Enc>,
	deserialize: (Enc) throws -> T
) throws where T: Hashable, Enc: Equatable {
	let count = 100
	var unique = Set<T>()
	for _ in 0 ..< count {
		let original = makeOriginal()
		unique.insert(original)
		let serialized = original[keyPath: serialize]
		let deserialized = try deserialize(serialized)
		#expect(deserialized == original)
		let reserialized = deserialized[keyPath: serialize]
		#expect(reserialized == serialized)
	}
	#expect(unique.count == count)
}



%{
	FEATURES = ["Schnorr", "ECDSA", "ECDSAWithKeyRecovery", "KeyAgreement"]
}%

% for FEATURE in FEATURES:
%{
	MODULE = "K1." + FEATURE
	PUBLIC_KEY_TYPE = MODULE + ".PublicKey"
}%

extension ${PUBLIC_KEY_TYPE} {
	init() {
		let pubKey = ${MODULE}.PrivateKey().publicKey
		try! self.init(compressedRepresentation: pubKey.compressedRepresentation)
	}
}

// MARK: ${PUBLIC_KEY_TYPE} Tests

@Suite("${PUBLIC_KEY_TYPE}")
struct ${FEATURE.replace('.','')+"PublicKey"}EncodingDecodingRoundtripTests {
	
	@Test
	func pubkey_raw_is_x963_minus_prefix() throws {
		
		let privateKey = ${MODULE}.PrivateKey()
		let publicKey = privateKey.publicKey
		#expect(publicKey.rawRepresentation.hex == Data(publicKey.x963Representation.dropFirst()).hex)
	}

	@Test
	func rawRoundtrip() throws {
		try doTest(
			original: ${PUBLIC_KEY_TYPE}(),
			serialize: \.rawRepresentation,
			deserialize: ${PUBLIC_KEY_TYPE}.init(rawRepresentation:)
		)
	}

	@Test
	func compressedRoundtrip() throws {
		try doTest(
			original: ${PUBLIC_KEY_TYPE}(),
			serialize: \.compressedRepresentation,
			deserialize: ${PUBLIC_KEY_TYPE}.init(compressedRepresentation:)
		)
	}

	@Test
	func x963Roundtrip() throws {
		try doTest(
			original: ${PUBLIC_KEY_TYPE}(),
			serialize: \.x963Representation,
			deserialize: ${PUBLIC_KEY_TYPE}.init(x963Representation:)
		)
	}

	@Test
	func derRoundtrip() throws {
		try doTest(
			original: ${PUBLIC_KEY_TYPE}(),
			serialize: \.derRepresentation,
			deserialize: ${PUBLIC_KEY_TYPE}.init(derRepresentation:)
		)
	}

	@Test
	func pemRoundtrip() throws {
		try doTest(
			original: ${PUBLIC_KEY_TYPE}(),
			serialize: \.pemRepresentation,
			deserialize: ${PUBLIC_KEY_TYPE}.init(pemRepresentation:)
		)
	}
}

% end
